<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mis Postulaciones • Portal de Empleos</title>

  <!-- Header/Footer dinámicos por rol -->
  <link rel="stylesheet" href="/css/styles.css" />
  <script src="/js/nav.js" defer></script>

  <style>
    :root{
      --brand:#1abc9c;
      --brand-2:#4bc0c8; /* azul suave */
      --ink:#2c3e50;
      --muted:#6c7a89;
      --chip:#ecf0f1;
      --bg:#f5f7fb;
      --card:#ffffff;
      --border:#e9edf2;
      --shadow: 0 12px 26px rgba(0,0,0,.06);
      --radius: 14px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, Arial, sans-serif; background:var(--bg); color:var(--ink); }

    /* Contenido */
    main{ max-width:980px; margin:28px auto; padding:0 16px; }
    h1{ margin:0 0 8px; font-size: clamp(20px,2.2vw,24px); }
    .sub{ color:var(--muted); margin:0 0 18px; }

    /* Tarjetas */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin:12px 0;
    }
    .row{ display:flex; justify-content:space-between; gap:16px; flex-wrap:wrap; }
    .meta{ color:var(--muted); font-size:13px; }
    .salary{ font-weight:700; }

    /* Chips/estado */
    .pill{ font-size:12px; padding:4px 10px; border-radius:999px; font-weight:700; letter-spacing:.2px; display:inline-block; }
    .st-applied   { background:#dfe6e9; color:#2c3e50; }
    .st-reviewing { background:#f6d6a6; color:#8a5a00; }
    .st-hired     { background:#bdebd1; color:#0c6d2d; }
    .st-rejected  { background:#f5b7b1; color:#7b241c; }

    /* Botones */
    .btn{ background:var(--brand); color:#fff; border:none; border-radius:10px; padding:9px 12px; cursor:pointer; font-weight:700; }
    .btn.danger{ background:#e74c3c; }
    .btn.ghost{ background:var(--chip); color:var(--ink); }

    .actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    /* Vacío */
    .empty{
      color:#7f8c8d; background:#fff; border:1px dashed var(--border);
      border-radius:12px; padding:18px; text-align:center; margin-top:12px;
    }
  </style>
</head>
<body>
  <!-- Header moderno inyectado por nav.js -->
  <header id="appHeader"></header>

  <main>
    <h1>Mis Postulaciones</h1>
    <p class="sub">Aquí puedes revisar el estado de cada postulación y cancelar si aún está en proceso.</p>

    <section id="appsList">
      <p class="meta">Cargando tus postulaciones…</p>
    </section>
  </main>

  <!-- Footer moderno inyectado por nav.js -->
  <footer id="appFooter"></footer>

  <script>
    const state = { user: null };

    const fmtMoney = (n) => {
      if (n == null || n === '' || isNaN(Number(n))) return '—';
      return new Intl.NumberFormat('es-CO', { style:'currency', currency:'COP', maximumFractionDigits:0 }).format(Number(n));
    };
    const fmtDate = (d) => new Date(d).toLocaleString();

    function badge(status){
      const s = (status || 'APPLIED').toUpperCase();
      if (s === 'REVIEWING') return '<span class="pill st-reviewing">REVIEWING</span>';
      if (s === 'HIRED')     return '<span class="pill st-hired">HIRED</span>';
      if (s === 'REJECTED')  return '<span class="pill st-rejected">REJECTED</span>';
      return '<span class="pill st-applied">APPLIED</span>';
    }
    function cancellable(status){
      const s = (status || 'APPLIED').toUpperCase();
      return s === 'APPLIED' || s === 'REVIEWING';
    }

    async function fetchSession() {
      try {
        const r = await fetch('/api/auth/me');
        const data = await r.json();
        state.user = data.user || null;

        // Solo USERS pueden ver esta página
        if (!state.user) {
          alert('Debes iniciar sesión para ver tus postulaciones.');
          location.href = '/login.html?next=/applications.html';
          return;
        }
        if (state.user.role !== 'USER'){
          alert('Esta página es solo para usuarios postulantes.');
          location.href = '/dashboard.html';
          return;
        }

        loadApplications();
      } catch (e) {
        console.error(e);
        document.getElementById('appsList').innerHTML = '<p class="empty">No pudimos verificar tu sesión.</p>';
      }
    }

    async function loadApplications() {
      const list = document.getElementById('appsList');
      try {
        const r = await fetch('/api/applications/mine');
        const data = await r.json();

        const apps = data.applications || data;
        if (!Array.isArray(apps) || !apps.length) {
          list.innerHTML = '<div class="empty">No tienes postulaciones aún. <br/>Visita la página de inicio para postularte a un empleo.</div>';
          return;
        }

        list.innerHTML = apps.map(appCard).join('');
        bindCancelButtons();
      } catch (e) {
        console.error('loadApplications error:', e);
        list.innerHTML = '<p class="empty">Error cargando tus postulaciones.</p>';
      }
    }

    function appCard(a) {
      const canCancel = cancellable(a.status);
      return `
        <article class="card">
          <div class="row">
            <div>
              <h3 style="margin:0 0 6px">${a.title}</h3>
              <div class="meta">Empresa: <b>${a.company}</b> · Ubicación: ${a.location || '—'}</div>
              <div class="meta">Salario: <span class="salary">${fmtMoney(a.salary)}</span></div>
              <div class="meta">Postulado: ${fmtDate(a.created_at)}</div>
            </div>
            <div class="actions">
              <div>Estado: ${badge(a.status)}</div>
              ${canCancel ? `<button class="btn danger cancel-btn" data-id="${a.application_id}">Cancelar</button>` : ''}
            </div>
          </div>
        </article>
      `;
    }

    function bindCancelButtons() {
      document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          if (!confirm('¿Deseas cancelar esta postulación?')) return;
          try {
            const r = await fetch(`/api/applications/${id}`, { method: 'DELETE' });
            const j = await r.json().catch(()=>({}));
            if (r.ok) {
              await loadApplications();
            } else {
              alert(j.error || j.msg || 'Error al eliminar.');
            }
          } catch (e) {
            console.error(e);
            alert('Error de red al eliminar.');
          }
        });
      });
    }

    fetchSession();
  </script>
</body>
</html>
